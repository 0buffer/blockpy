<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Iframe Blockly</title>
  <style>
    html, body {
      height: 100%;
    }
    body {
      background-color: #fff;
      font-family: sans-serif;
      margin-top: 0;
      margin-bottom: 0;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    iframe {
      width: 100%;
      height: 100%;
      border-style: solid;
      border-color: #ddd;
      border-width: 0 1px 1px 0;
    }
  </style>
  <script src="libs/jquery.js"></script>
  <script type="text/javascript" src="libs/d3.min.js"></script>
  <script type="text/javascript" src="libs/math.0.19.0.min.js"></script>
  
    
    <!-- Skulpt -->
    <script type="text/javascript" src="skulpt/dist/skulpt.min.js"></script>
    <script type="text/javascript" src="skulpt/dist/skulpt-stdlib.js"></script>
    <script type="text/javascript" src="analyzer.js"></script>
    <script type="text/javascript" src="python_to_blockly.js"></script>
    <script type="text/javascript">
        function outf(text)
        {
            var output = document.getElementById("html-output");
            text = text.replace(/</g, '&lt;');
            output.innerHTML = output.innerHTML + text;
        }
        
        function builtinRead(x) {
            if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                throw "File not found: '" + x + "'";
            return Sk.builtinFiles["files"][x];
        }
        
        function runit() {
            runProgram(window.Blockly.Python.workspaceToCode());
        }
        
        function resetit() {
            var code = '<xml xmlns="http://www.w3.org/1999/xhtml"> <block type="controls_if" inline="false" x="22" y="4"> <mutation elseif="1"></mutation> <statement name="DO1"> <block type="variables_set" inline="false"> <title name="VAR">item</title> <value name="VALUE"> <block type="variables_get"> <title name="VAR">item</title> </block> </value> <next> <block type="variables_set" inline="false"> <title name="VAR">item</title> <value name="VALUE"> <block type="math_number"> <title name="NUM">1</title> </block> </value> <next> <block type="variables_set" inline="false"> <title name="VAR">item</title> <value name="VALUE"> <block type="math_number"> <title name="NUM">2</title> </block> </value> <next> <block type="variables_set" inline="false"> <title name="VAR">item</title> <value name="VALUE"> <block type="math_number"> <title name="NUM">3</title> </block> </value> </block> </next> </block> </next> </block> </next> </block> </statement> </block> </xml>';
            var xml = Blockly.Xml.textToDom(code);
            Blockly.mainWorkspace.clear();
            Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
            align();
        }

        function runProgram(prog)
        {
            var output = document.getElementById("html-output");
            output.innerHTML = '';
            Sk.configure({output:outf, read: builtinRead});
            Sk.canvas = "mycanvas";
            var time = 0;
            Sk.afterSingleExecution = function($gbl) {
                console.log(time, $gbl);
                time += 1;
            };
            try {
                var module = Sk.importMainWithBody("<stdin>", false, prog);
                Sk.afterSingleExecution(module.$d);
                //var obj = module.tp$getattr('a');
                //var runMethod = obj.tp$getattr('run');
                //var ret = Sk.misceval.callsim(runMethod, 10);
                //alert(ret.v);
            } catch (e) {
                alert(e);
            }
        }
    </script>
  
</head>
<body>
  <table width="100%" height="99%">
    <tr>
      <td width="66%">
        <h1>CORGIS Blockly &gt;
      </td>
    </tr>
    <tr>
      <td height="99%">
        <script>
        
            function align(){
                var blocks = Blockly.getMainWorkspace().getTopBlocks();
                var y = 20;
                for (var i = 0; i < blocks.length; i++){
                    blocks[i].moveTo(Blockly.Toolbox.width+20, y);
                    y += blocks[i].getHeightWidth().height;
                    y += 20; // buffer
                }
            }

          waitQueue = [];
          function buildIptUrl(code, instruction) {
            console.log( encodeURI(code));
            return "http://localhost:8080/iframe-embed.html#&code=" + encodeURIComponent(code) + "&py=2&cumulative=false&curInstr=0";
          }
          
          function clearit() {
            Blockly.mainWorkspace.clear();
          }
          
          function analyzeit() {
            try {
                analyze_code();
            } catch (e) {
                console.error("Analyzer: ", e, e.stack);
            }
          }
          
          function convertit() {
            try {
                var code = $("#python-output").text();
                var xml = (new Python2Blockly()).convert(code);
                var xmlString = new XMLSerializer().serializeToString(xml);
                var blocklyXML = Blockly.Xml.textToDom(xmlString);
                console.log(xmlString);
                Blockly.mainWorkspace.clear();
                Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, blocklyXML);
                align();
            } catch (e) {
                console.error("P2B: ", e, e.stack);
            }
          }
          function update_delay() {
            if (waitQueue.length <= 1) {
                $("#ipt-td").html();
                var code = window.Blockly.Python.workspaceToCode();
                $("#python-output").html(code);
                var dom = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
                $("#xml-output").text(Blockly.Xml.domToPrettyText(dom));
                //$("#ipt-td").html('<iframe id="ipt" frameborder="0" src="'+buildIptUrl(code)+'"></iframe>');
            }
            waitQueue.pop();
          }
          $(document).on("update_blockly", function() {
            waitQueue.push(1);
            window.setTimeout(update_delay, 0000);
          });
          function blocklyLoaded(blockly) {
            // Called once Blockly is fully loaded.
            window.Blockly = blockly;
            blockly.addChangeListener(function () {
                $(document).trigger("update_blockly");
            });
          }
          $(document).ready(function() {
            //$("#ipt").attr("src", "http://localhost:8080/iframe-embed.html#&code=print+7&py=2&cumulative=false&curInstr=0");
          });
        </script>
        <iframe src="frame.html"></iframe>
      </td>
      <td>
        <pre id="python-output">
        </pre>
        <button onclick="runit()" type="button">Run</button>
        <button onclick="convertit()" type="button">Convert</button>
        <button onclick="resetit()" type="button">Reset</button>
        <button onclick="analyzeit()" type="button">Analyze</button>
        <button onclick="clearit()" type="button">Clear</button>
        <pre id="html-output"></pre>
        <div id="mycanvas"></div>
      </td>
  </tr>
  <tr>
      <td colspan='2'>
        <div id="xml-output" style='font-size:6pt'>
        </div>
      </td>
      <!--<td id="ipt-td">
        <iframe id="ipt" frameborder="0"
                src="http://localhost:8080/iframe-embed.html#&code=print+3&py=2&cumulative=false&curInstr=0">
        </iframe>
      </td>-->
    </tr>
  </table>

</body>
</html>
