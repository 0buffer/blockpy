<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Blockly Demo: Iframe Blockly</title>
    
    <link rel="stylesheet" href="libs/bootstrap.min.css">
    <link rel="stylesheet" href="libs/codemirror.css">
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">-->
    <style>
        html, body {
            height: 100%;
        }
        body {
            background-color: #fff;
            font-family: sans-serif;
            margin-top: 0;
            margin-bottom: 0;
        }
        h1 {
            font-weight: normal;
            font-size: 140%;
        }
        iframe {
            width: 100%;
            height: 100%;
            border-style: solid;
            border-color: #ddd;
            border-width: 0 1px 1px 0;
        }
    </style>
    
    <!-- JQuery, D3, Math.js, Bootstrap -->
    <script type="text/javascript" src="libs/jquery.js"></script>
    <script type="text/javascript" src="libs/d3.min.js"></script>
    <script type="text/javascript" src="libs/math.0.19.0.min.js"></script>
    <script type="text/javascript" src="libs/bootstrap.min.js"></script>
    <script type="text/javascript" src="libs/codemirror.js"></script>
    <script type="text/javascript" src="libs/codemirror_python.js"></script>
  
    <!-- Datasets -->
    <script type="text/javascript" src="libs/crime_data.js"></script>
    
    <!-- Blockly -->
    <script type="text/javascript" src="blockly/blockly_uncompressed.js"></script>
    <script type="text/javascript" src="blockly/blocks_compressed.js"></script>
    <script type="text/javascript" src="blockly/python_compressed.js"></script>
    <script type="text/javascript" src="blockly/javascript_compressed.js"></script>
    <script type="text/javascript" src="blockly/msg/js/en.js"></script>
    
    <!-- Skulpt -->
    <script type="text/javascript" src="skulpt/dist/skulpt.min.js"></script>
    <script type="text/javascript" src="skulpt/dist/skulpt-stdlib.js"></script>
    
    <!-- Analyzer -->
    <script type="text/javascript" src="analyzer/analyzer.js"></script>
    
    <!-- Converter -->
    <script type="text/javascript" src="converter/python_to_blockly.js"></script>
    
    <!-- Analyzer -->
    <script type="text/javascript" src="kennel/kennel.js"></script>
    
    <!-- Renderer -->
    <script type="text/javascript" src="converter/renderBlocklyToPng.js"></script>
    
    
    <script type="text/javascript">
        
        function resetit() {
            var code = '<xml xmlns="http://www.w3.org/1999/xhtml"> <block type="variables_set" id="1" inline="false" x="-19" y="16"> <field name="VAR">property_name</field> <value name="VALUE"> <block type="lists_create_empty" id="12"></block> </value> <next> <block type="controls_forEach" id="24" inline="false"> <field name="VAR">i</field> <value name="LIST"> <block type="variables_get" id="34"> <field name="VAR">property_name</field> </block> </value> <statement name="DO"> <block type="lists_append" id="20" inline="true"> <value name="ITEM"> <block type="math_number" id="39"> <field name="NUM">0</field> </block> </value> <value name="LIST"> <block type="variables_get" id="35"> <field name="VAR">property_name</field> </block> </value> </block> </statement> </block> </next> </block> </xml>';
            var xml = Blockly.Xml.textToDom(code);
            Blockly.mainWorkspace.clear();
            Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
            align();
        }
        
        function parseValue(property, value) {
            console.log(value);
            switch (value.constructor) {
                case Sk.builtin.func:
                    return {'name': property,
                            'type': "Function",
                            "value":  
                                (value.func_code.co_varnames !== undefined ?
                                 " Arguments: "+value.func_code.co_varnames.join(", ") :
                                 ' No arguments')
                            };
                case Sk.builtin.module: return null;
                case Sk.builtin.str:
                    return {'name': property,
                        'type': "String",
                        "value": value.$r().v
                    };
                case Sk.builtin.none:
                    return {'name': property,
                        'type': "None",
                        "value": "None"
                    };
                case Sk.builtin.bool:
                    return {'name': property,
                        'type': "Boolean",
                        "value": value.$r().v
                    };
                case Sk.builtin.nmber:
                    return {'name': property,
                        'type': "int" == value.skType ? "Integer": "Float",
                        "value": value.$r().v
                    };
                case Sk.builtin.list:
                    return {'name': property,
                        'type': "List",
                        "value": value.$r().v
                    };
                case Sk.builtin.dict:
                    return {'name': property,
                        'type': "Dictionary",
                        "value": value.$r().v
                    };
                case Number:
                    return {'name': property,
                        'type': value % 1 === 0 ? "Integer" : "Float",
                        "value": value
                    };
                case String:
                    return {'name': property,
                        'type': "String",
                        "value": value
                    };
                case Boolean:
                    return {'name': property,
                        'type': "Boolean",
                        "value": (value ? "True": "False")
                    };
                default:
                    return {'name': property,
                            'type': value.$r().v,
                            "value": value.$r().v
                            };
            }
        }
        
        function parseGlobals(globals) {
            var result = Array();
            for (var property in globals) {
                value = globals[property];
                if (property !== "__name__") {
                    property = property.replace('_$rw$', '')
                                       .replace('_$rn$', '');
                    var parsed = parseValue(property, value);
                    if (parsed !== null) {
                        result.push(parsed);
                    }
                }
            }
            return result;
        }
        
        function reloadDataViewer(propertyList, page) {
            var last = propertyList.length-1;
            if (page < 0) {
                page = last+page+1;
            }
            
            Blockly.mainWorkspace.traceOn(true)
            // Clear out any existing data
            var tbl = $("#data-viewer");
            tbl.html('');
            function buildButton(next_page, label) {
                var button = $('<button>'+label+'</button>');
                button.click(function() { reloadDataViewer(propertyList, next_page)});
                return $("<td/>").append(button);
            }
            var row = $('<tr/>');
            row.append(buildButton(0, "First"));
            row.append(buildButton(Math.max(0, page-1), "Previous"));
            row.append($("<td/>"));
            row.append(buildButton(Math.min(last, page+1), "Next"));
            row.append(buildButton(last, "Last"));
            tbl.append(row);
            
            function renderData(property, value) {
                var row = $("<tr/>");
                row.append($("<td/>").text(value['name']));
                row.append($("<td />").text(value['type']));
                row.append($("<td colspan='3'/>").text(value['value']));
                return row;
            }
            
            if (propertyList[page] === undefined) {
                tbl.append($("<tr><td colspan='5'>No data found at this step!</td></tr>"));
            } else {
                var lineno = propertyList[page]['lineno'];
                if (page == last) {
                    tbl.append($("<tr><th colspan='5'>Completed</th></tr>"));
                } else {
                    tbl.append($("<tr><th colspan='5'>Step "+page+" (Line "+lineno+")</th></tr>"));
                }
                var block = propertyList[page]['block'];
                Blockly.mainWorkspace.highlightBlock(block);
                for (var property in propertyList[page]['properties']) {
                    var value = propertyList[page]['properties'][property];
                    row = renderData(property, value);
                    tbl.append(row);
                }
            }
           
        }
    </script>
  
</head>
<body>
        <!--<textarea style='width:100%;' id="python-output" class='language-python'></textarea><br>
        <button onclick="kennel.run();" type="button">Run</button>
        <button onclick="convertit()" type="button">Convert</button>
        <button onclick="resetit()" type="button">Reset</button>
        <button onclick="clearit()" type="button">Clear</button>
        <button onclick="layoutit()" type="button">Align</button>
        <button onclick="loadRedo()" type="button">R</button>
        <button onclick="loadUndo()" type="button">U</button>
        <button onclick="renderBlocklyCanvas('#my-image')" type="button">Picture</button>
        <br>
        Program Output:
        <pre id="html-output" style='max-width:400px'></pre>
        <div id="mycanvas"></div>
        State visualization:
        <table id='data-viewer' class='table table-condensed table-striped' width='100%'><tr></tr></table>-->
<div id="kennel-div" style='height:100%'></div>
        <script>
          
          var UNDO_STACK = Array();
          var REDO_STACK = Array();
          var SAVE_UNDO_FLAG = true;
          var MAXIMUM_UNDOS = 20;
          
          function saveUndo() {
              if (SAVE_UNDO_FLAG) {
                  if (UNDO_STACK.length >= MAXIMUM_UNDOS) {
                      UNDO_STACK.shift();
                  }
                  UNDO_STACK.push(getXml());
                  REDO_STACK = Array();
              } else {
                  SAVE_UNDO_FLAG = true;
              }
          }
          
          function loadUndo() {
              if (UNDO_STACK.length > 0) {
                  console.log("Popping undo");
                  SAVE_UNDO_FLAG = false;
                  var state = UNDO_STACK.pop();
                  REDO_STACK.push(state);
                  loadXml(state);
              }
          }
          
          function loadRedo() {
              if (REDO_STACK.length > 0) {
                  console.log("Popping redo");
                  SAVE_UNDO_FLAG = false;
                  var state = REDO_STACK.pop();
                  UNDO_STACK.push(state);
                  loadXml(state);
              }
          }
          
          
          $(document).ready(function() {
            kennel = new Kennel(document.getElementById('kennel-div'),
                                document.getElementById('toolbox'),
                                document.getElementById("html-output"));
            kennel.changeMode();
            kennel.setPythonFromText("print('Hello World!')");
          });
        </script>
  
  
<xml id="toolbox" style="display: none">
    <category name="Properties" custom="VARIABLE">
    </category>
    <category name="Decisions">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
    </category>
    <category name="Iteration">
        <block type="controls_forEach"></block>
    </category>
    <category name="Functions" custom="PROCEDURE">
    </category>
    <category name="Calculation">
        <block type="math_arithmetic"></block>
        <block type="type_check"></block>
        <block type="raw_block"></block>
        <block type="raw_expression"></block>
        <!--<block type="math_single"></block>
        <block type="math_number_property"></block>
        <block type="math_round"></block>
        <block type="text_join"></block>-->
    </category>
    <category name="Output">
        <block type="text_print"></block>
        <block type="plot_line"></block>
        <block type="plot_scatter"></block>
        <block type="plot_show"></block>
        <block type="plot_title"></block>
    </category>
    <sep></sep>
    <category name="Values">
        <block type="text"></block>
        <block type="math_number"></block>
        <block type="logic_boolean"></block>
    </category>
    <category name="Lists">
        <block type="lists_create_with"></block>
        <block type="lists_create_empty"></block>
        <block type="lists_append"></block>
        <block type="lists_length"></block>
    </category>
    <category name="Dictionaries">
        <block type="dicts_create_with"></block>
        <block type="dict_get_literal"></block>
        <block type="dict_keys"></block>
    </category>
    <sep></sep>
    <category name="Data - Weather">
        <block type="weather_temperature"></block>
        <block type="weather_report"></block>
        <block type="weather_forecasts"></block>
        <block type="weather_report_forecasts"></block>
        <block type="weather_all_forecasts"></block>
        <block type="weather_highs_lows"></block>
    </category>
    <category name="Data - Stock">
        <block type="stocks_current"></block>
        <block type="stocks_past"></block>
    </category>
    <category name="Data - Earthquakes">
        <block type="earthquake_get"></block>
        <block type="earthquake_both"></block>
        <block type="earthquake_all"></block>
    </category>
    <category name="Data - Crime">
        <block type="crime_state"></block>
        <block type="crime_year"></block>
        <block type="crime_all"></block>
    </category>
    <category name="Data - Books">
        <block type="books_get"></block>
    </category>
</xml>
  
<!-- Google Analytics -->
<script>
switch(window.location.protocol) {
case 'file:':
    break;
default:
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-38802329-2', 'auto');
    ga('send', 'pageview');
    }
</script>

</body>
</html>
